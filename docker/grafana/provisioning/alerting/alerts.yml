apiVersion: 1

contactPoints:
  - orgId: 1
    name: slack-ops
    receivers:
      - uid: slack-ops
        type: slack
        settings:
          url: $SLACK_WEBHOOK_URL
          title: "Vizora Alert: {{ .CommonLabels.alertname }}"
          text: |
            {{ range .Alerts }}
            **{{ .Labels.alertname }}** â€” {{ .Labels.severity }}
            {{ .Annotations.summary }}
            {{ end }}

policies:
  - orgId: 1
    receiver: slack-ops
    group_by:
      - grafana_folder
      - alertname
    group_wait: 30s
    group_interval: 5m
    repeat_interval: 4h

groups:
  - orgId: 1
    name: Vizora Platform Alerts
    folder: Vizora
    interval: 1m
    rules:
      # Device offline for more than 5 minutes
      - uid: device-offline
        title: Device Offline > 5 minutes
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: prometheus
            model:
              expr: 'time() - vizora_device_last_heartbeat_timestamp > 300'
              intervalMs: 60000
              maxDataPoints: 43200
          - refId: C
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: '-100'
            model:
              conditions:
                - evaluator:
                    type: gt
                    params: [0]
                  operator:
                    type: and
                  query:
                    params: [A]
              type: classic_conditions
        noDataState: OK
        execErrState: Alerting
        for: 5m
        annotations:
          summary: 'A display device has been offline for more than 5 minutes'
        labels:
          severity: warning

      # Error rate spike > 5% over 5 minute window
      - uid: error-rate-spike
        title: Error Rate > 5%
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: |
                (
                  sum(rate(vizora_http_errors_total[5m]))
                  /
                  sum(rate(vizora_http_requests_total[5m]))
                ) * 100
              intervalMs: 60000
              maxDataPoints: 43200
          - refId: C
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: '-100'
            model:
              conditions:
                - evaluator:
                    type: gt
                    params: [5]
                  operator:
                    type: and
                  query:
                    params: [A]
              type: classic_conditions
        noDataState: OK
        execErrState: Alerting
        for: 5m
        annotations:
          summary: 'HTTP error rate has exceeded 5% over the last 5 minutes'
        labels:
          severity: critical

      # Memory usage > 85%
      - uid: high-memory
        title: Memory Usage > 85%
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: |
                (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100
              intervalMs: 60000
              maxDataPoints: 43200
          - refId: C
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: '-100'
            model:
              conditions:
                - evaluator:
                    type: gt
                    params: [85]
                  operator:
                    type: and
                  query:
                    params: [A]
              type: classic_conditions
        noDataState: OK
        execErrState: Alerting
        for: 5m
        annotations:
          summary: 'Memory usage has exceeded 85%'
        labels:
          severity: warning

      # Disk usage > 90%
      - uid: high-disk
        title: Disk Usage > 90%
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: |
                (1 - (node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"})) * 100
              intervalMs: 60000
              maxDataPoints: 43200
          - refId: C
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: '-100'
            model:
              conditions:
                - evaluator:
                    type: gt
                    params: [90]
                  operator:
                    type: and
                  query:
                    params: [A]
              type: classic_conditions
        noDataState: OK
        execErrState: Alerting
        for: 5m
        annotations:
          summary: 'Disk usage has exceeded 90%'
        labels:
          severity: critical
